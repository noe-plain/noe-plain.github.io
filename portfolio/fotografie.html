<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="../../images/illustrationen/logos/favicon.png">
    <title>Fotografie – Medien vom Noé</title>

    <link rel="stylesheet" href="../../style.css">

    <link rel="stylesheet" href="gallery-overlay.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/exifr/dist/lite.umd.js"></script>

    <meta name="description" content="Showcase der Fotografien von Noé.">

    <style>
        /* Container-Verhalten für Tabs */
        .gallery-section {
            display: none;
            /* Verstecke alle Sektionen standardmäßig */
            animation: fadeIn 0.4s ease-in-out;
        }

        .gallery-section.active {
            display: block;
            /* Zeige nur die aktive Sektion */
        }

        /* Page-Nav Styling als Reiter */
        #page-nav {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow-x: auto;
            overflow-y: hidden;
            flex-wrap: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
            min-width: 0;
            white-space: nowrap;
            display: flex;
            gap: 10px;
            border-bottom: 1px solid #ddd;
            padding-bottom: -1px;
        }

        #page-nav::-webkit-scrollbar {
            display: none;
            height: 0;
        }

        #page-nav a.tab-btn {
            flex: 0 0 auto;
        }

        @media (max-width: 800px) {
            #page-nav {
                min-width: 0 !important;
                overflow-x: auto !important;
                overflow-y: hidden !important;
                scrollbar-width: none !important;
                -webkit-overflow-scrolling: none !important;
                -ms-overflow-style: none !important;
            }

            #page-nav::-webkit-scrollbar {
                display: none;
                height: 0;
            }
        }

        #page-nav a.tab-btn {
            background-color: transparent;
            color: #333;
            box-shadow: none;
            border: 1px solid transparent;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s ease;
            padding: 10px 20px;
            margin-bottom: -1px;
        }

        #page-nav a.tab-btn:first-of-type {
            margin-left: 0 !important;
        }

        #page-nav a.tab-btn.active {
            background-color: #1f0033;
            color: #fff;
            border-color: #1f0033;
        }

        #page-nav a.tab-btn:hover {
            border-color: #ddd;
        }

        /* Animation für den Tab-Wechsel */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Masonry: responsive Grid — Anzahl der Spalten wird per JS berechnet (wie Unsplash) */
        .project-gallery {
            display: grid;
            /* Fallback, JS überschreibt später die exakte Spaltenanzahl */
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            column-gap: 14px;
            align-items: start;
            grid-auto-rows: 8px;
            grid-auto-flow: row;
        }

        /* Page-Nav scroll buttons (wieder eingefügt) */
        .page-nav-scroll-btn {
            position: fixed;
            z-index: 60;
            width: 48px;
            height: 43px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            color: #1f0033;
            border: none;
            cursor: pointer;
            padding: 0;
            box-shadow: none;
            transition: opacity .18s ease, transform .18s ease;
            isolation: isolate;
            background: linear-gradient(90deg, rgba(247, 247, 247, 0) 0%, rgba(247, 247, 247, 0.67) 50%, #f7f7f7 100%);
        }

        #page-nav-left-gradient {
            z-index: 61;
            background: linear-gradient(270deg, rgba(247, 247, 247, 0) 0%, rgba(247, 247, 247, 0.67) 50%, #f7f7f7 100%);
        }

        .page-nav-scroll-btn.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateX(6px);
        }

        /* --- In style.css --- */

        .project-gallery {
            margin: 20px 0 0 0;
            display: grid;
            /* Wir setzen den Gap strikt auf 15px wie gewünscht */
            gap: 15px;
            column-gap: 15px;
            grid-auto-rows: 8px;
            /* Feinraster für Masonry */
        }

        /* Der Container für das Bild */
        .gallery-item {
            display: block;
            border-radius: 15px 0 15px 15px !important;

            /* WICHTIG für den Zoom-Effekt ohne den Container zu vergrössern: */
            overflow: hidden;
            position: relative;
            height: 100%;
            /* Füllt die vom JS berechnete Grid-Höhe komplett aus */

            /* Optional: Hardware-Beschleunigung für flüssigere Animation */
            transform: translateZ(0);
        }

        /* Das Bild selbst */
        .gallery-item img {
            width: 100%;
            height: 100%;

            /* WICHTIG: Das Bild wird beschnitten, um den Container zu füllen */
            object-fit: cover;

            /* Die Animation */
            transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform-origin: center center;
        }

        /* Hover Effekt: Zoom */
        .gallery-item:hover img {
            transform: scale(1.05);
            /* Zoom auf 105% */
        }

        @media (max-width: 420px) {
            .page-nav-scroll-btn {
                width: 40px;
                font-size: 20px;
            }
        }

        /* Loader-Styling */
        #loader {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
        }

        #loader.visible {
            display: flex;
        }

        .loader-inner {
            text-align: center;
            color: #1f0033;
            font-family: switzer, sans-serif;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 5px solid rgba(31, 0, 51, 0.12);
            border-top-color: #1f0033;
            border-radius: 50%;
            animation: spin 1.7s linear infinite;
            margin: 0 auto 10px auto;
        }

        .loader-text {
            font-size: 14px;
            opacity: 0.9;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <header>
        <nav class="header-nav">
            <a class="logo-a" href="../index.html">Medien von <span>Noé</span></a>
            <button class="hamburger-btn" id="hamburgerBtn" aria-label="Menü öffnen">
                <span></span>
                <span></span>
                <span id="small-bar"></span>
            </button>
        </nav>
        <div class="hamburger-nav-bg" id="hamburgerNavBg"></div>
        <nav class="hamburger-nav-overlay" id="hamburgerNav">
            <div class="hamburger-nav-links">
                <a class="hamburger-nav-link" href="../search.html">Search &#8197; &#128270;</a>
                <hr>
                <a class="hamburger-nav-link" href="../index.html">Medien von Noé</a>
                <a class="hamburger-nav-link" href="../index.html#portfolio">Portfolio</a>
                <a class="hamburger-nav-link" href="../index.html#about">Das bin ich</a>
                <a class="hamburger-nav-link" href="../index.html#contact">Kontakt</a>
            </div>
        </nav>
    </header>

    <main class="max-width">
        <div class="detail-hero max" style="background-image: url(../images/portfolio/photography/hero-image.jpeg);">
            <div class="detail-hero-overlay"></div>
            <div class="detail-hero-content max-width">
                <h1>Photo&shy;graphy</h1>
                <p class="detail-hero-beschreibung">
                    Die Fotografie ist eine meiner Grossen Leidenschaften. Ob Street Photography, Luftfahrt, Porträts
                    oder Events wie Hochzeiten – ich liebe es, Momente einzufangen und Geschichten durch Bilder zu
                    erzählen.
                </p>
                <div class="projekt-kurzinfo">
                    <ul>
                        <li><strong>Rolle:</strong> Fotograf</li>
                        <li><strong>Equipment:</strong> Sony A7C II & Canon R6 MII</li>
                        <li><strong>Tools:</strong> Lightroom, Photoshop</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- linke/rechte Steuer-Buttons wieder eingefügt -->
        <button id="page-nav-left-gradient" class="page-nav-scroll-btn hidden" aria-hidden="true" title="Zurück"
            tabindex="0" type="button">&lt;</button>
        <button id="page-nav-scroll-btn" class="page-nav-scroll-btn" aria-label="Weiter scrollen" title="Mehr"
            type="button">&gt;</button>

        <div id="page-nav">
            <a href="?favorite" class="tab-btn"><i class="fa-solid fa-heart"></i></a>
            <a href="?street" class="tab-btn">Street</a>
            <a href="?portraet" class="tab-btn">Porträt</a>
            <a href="?aviation" class="tab-btn">Aviation</a>
            <a href="?bts" class="tab-btn">BTS</a>
            <a href="?event" class="tab-btn">Event</a>
        </div>

        <div id="gallery-container">

            <div id="loader" aria-hidden="true">
                <div class="loader-inner">
                    <div class="spinner" aria-hidden="true"></div>
                    <div class="loader-text">Bilder werden geladen…</div>
                </div>
            </div>

            <div id="section-street" class="gallery-section active">
                <h2>Street Photo&shy;graphy</h2>
                <div id="lightgallery-street" class="project-gallery"></div>
            </div>

            <div id="section-favorite" class="gallery-section">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                    <h2 style="margin:0;">Favoriten</h2>
                    <button class="icon-btn" onclick="downloadFavoritesZip()" id="download-all-favs"
                        style="display:none; width:auto; padding:0 20px; border-radius:12px; font-size:1rem; gap:8px;">
                        <i class="fas fa-file-archive"></i> Alle als ZIP laden
                    </button>
                </div>
                <div id="lightgallery-favorite" class="project-gallery"></div>
            </div>

            <div id="section-aviation" class="gallery-section">
                <h2>Aviation Photo&shy;graphy</h2>
                <div id="lightgallery-aviation" class="project-gallery"></div>
            </div>

            <div id="section-portraet" class="gallery-section">
                <h2>Porträt Foto&shy;grafie</h2>
                <div id="lightgallery-portraet" class="project-gallery"></div>
            </div>

            <div id="section-bts" class="gallery-section">
                <h2>BTS</h2>
                <div id="lightgallery-bts" class="project-gallery"></div>
            </div>

            <div id="section-event" class="gallery-section">
                <h2>Event Photo&shy;graphy</h2>
                <div id="lightgallery-event" class="project-gallery"></div>
            </div>
        </div>
    </main>

    <footer>
        <nav class="footer-nav">
            <svg class="footer-logo" preserveAspectRatio="xMidYMid meet" data-bbox="55.13 44.69 1889.73 1060.63"
                viewBox="55.13 44.69 1889.73 1060.63" xmlns="http://www.w3.org/2000/svg" data-type="color"
                role="presentation" aria-hidden="true" aria-label="">
                <g>
                    <path
                        d="M1769.49 865.92h16.55v235.35h-16.55zm16.54 92.64h-8.94q2.235-30 14.34-51.9c8.02-14.62 18.71-25.8 31.97-33.56 13.27-7.76 28.12-11.65 44.52-11.65s30.74 3.29 42.05 9.85c11.36 6.58 20 15.88 25.95 27.96 5.97 12.09 8.94 26.79 8.94 44.08v157.94h-17.01V947.39c0-13.73-2.21-25.97-6.68-36.7-4.47-10.75-11.41-19.15-20.82-25.27-9.42-6.12-21.7-9.18-36.92-9.18-12.23 0-23.13 2.47-32.63 7.38-9.56 4.91-17.69 11.49-24.42 19.68-6.68 8.2-11.77 17.15-15.21 26.84-3.45 9.71-5.15 19.17-5.15 28.42"
                        fill="#ddcfe6" data-color="1"></path>
                    <path d="M1602.26 1101.29h16.56V865.93h-16.56zm0-272.93h16.56v-49.23h-16.56z" fill="#ddcfe6"
                        data-color="1"></path>
                    <path
                        d="M1437.61 964.36v12.99c-31.91 0-58.08 1.49-78.5 4.46-20.46 2.99-36.24 7.18-47.44 12.53-11.16 5.36-18.93 11.87-23.24 19.48-4.37 7.6-6.53 16.04-6.53 25.27 0 16.11 5.61 28.78 16.82 38.04 11.15 9.25 26.62 13.88 46.31 13.88 16.4 0 31.31-4.27 44.72-12.77 13.42-8.48 24.16-19.67 32.23-33.55 8.02-13.88 12.09-28.7 12.09-44.51h9.81c-1.18 18.5-5.09 34.36-11.61 47.64-6.58 13.27-14.86 24.16-24.83 32.67-10.03 8.49-20.62 14.76-31.77 18.79-11.21 4.01-21.85 6.04-32.03 6.04-16.4 0-30.38-2.53-42.05-7.6-11.61-5.07-20.66-12.54-27.04-22.38-6.42-9.85-9.61-21.62-9.61-35.34 0-16.12 4.16-29.15 12.48-39.15 8.38-10 20.77-17.53 37.17-22.6 16.71-5.68 34.6-9.41 53.67-11.17 19.07-1.8 42.2-2.7 69.34-2.7m-148.08-21.94h-16.97c2.67-16.99 7.71-31.53 15.16-43.62 7.46-12.08 17.84-21.32 31.1-27.72 13.32-6.43 29.36-9.64 48.11-9.64s34.85 3.67 47.19 10.97c12.39 7.3 21.6 17.66 27.55 31.1 5.96 13.42 8.94 29.38 8.94 47.85v96.64c0 12.23.82 22.62 2.47 31.1 1.59 8.51 4.21 15.88 7.81 22.15h-18.35c-3.59-5.96-5.9-13.34-6.93-22.15-1.04-8.8-1.54-17.22-1.54-25.27V953.61c0-24.76-5.45-43.86-16.36-57.27-10.89-13.42-28.42-20.12-52.59-20.12s-40.55 5.96-52.79 17.89c-12.23 11.92-19.85 28.04-22.82 48.32"
                        fill="#ddcfe6" data-color="1"></path>
                    <path fill="#ddcfe6" d="M1125.34 779.13v322.16h-16.56V779.13z" data-color="1"></path>
                    <path
                        d="M776.15 797.05h17.43v304.24h-17.43zm93.03 183.87h-81.89V966.6h81.42c26.83 0 48.27-6.94 64.2-20.8 15.99-13.88 23.96-32.74 23.96-56.6s-7.98-43.18-23.96-57.06c-15.93-13.88-37.22-20.8-63.74-20.8h-81.89v-14.31h81.89c21.18 0 39.69 3.73 55.47 11.17 15.83 7.46 28.06 18.05 36.7 31.77 8.63 13.72 12.95 29.98 12.95 48.76 0 28.94-9.51 51.54-28.64 67.8-19.07 16.24-44.56 24.37-76.49 24.37"
                        fill="#ddcfe6" data-color="1"></path>
                    <path
                        d="M1519.92 419.64c-15.52 0-25.81 7.99-30.84 23.95-5.09 15.96-7.92 38.09-8.53 66.44h47.44c9.56 0 15.78-3.06 18.77-9.17 2.97-6.12 4.47-14.4 4.47-24.84s-.68-19.92-2.01-28.42c-1.34-8.48-4.21-15.26-8.69-20.36-4.47-5.07-11.37-7.6-20.62-7.6m-102.45 109.62c0-38.76 9-67.34 27.09-85.67 18.05-18.35 43.18-27.53 75.36-27.53 28.64 0 48.99 5.97 61.07 17.9 12.08 11.94 18.15 27.16 18.15 45.65 0 5.68-.68 11.56-2.01 17.67-1.34 6.12-3.4 11.55-6.07 16.32h-110.51v15.66c0 21.79 1.59 40.35 4.72 55.72 3.14 15.34 8.94 27.14 17.43 35.34 8.48 8.2 21.13 12.31 37.84 12.31 10.12 0 19.07-2.39 26.83-7.16 7.76-4.79 13.77-10.98 18.09-18.56 4.31-7.6 6.52-15.29 6.52-23.06h4.01c0 8.67-2.61 17.46-7.82 26.41-5.24 8.94-13.36 16.47-24.41 22.59s-25.49 9.18-43.38 9.18c-32.79 0-58.2-8.79-76.08-26.39-17.89-17.61-26.83-46.37-26.83-86.36m96.18-143.65-3.13-2.67c10.43-11.93 18.5-24.91 24.15-38.94 5.71-14 9.56-27.73 11.67-41.14l40.71 13.84c-7.45 13.44-17.63 26.19-30.43 38.28-12.85 12.08-27.14 22.3-42.98 30.63"
                        fill="#ddcfe6" data-color="1"></path>
                    <path
                        d="M1245.88 528.35c0-26.83-1.28-48.17-3.81-63.97-2.57-15.8-6.78-27.22-12.74-34.23-5.97-6.98-14.19-10.51-24.63-10.51s-18.19 3.53-24.16 10.51c-5.96 7.02-10.29 18.43-12.95 34.23-2.73 15.8-4.06 37.14-4.06 63.97s1.33 48.71 4.06 64.67c2.67 15.95 7 27.5 12.95 34.66 5.97 7.18 14.04 10.75 24.16 10.75s18.66-3.57 24.63-10.75c5.96-7.16 10.17-18.71 12.74-34.66 2.52-15.96 3.81-37.5 3.81-64.67m63.07 0c0 75.77-34.75 113.65-104.25 113.65s-104.25-37.88-104.25-113.65 34.74-112.29 104.25-112.29 104.25 37.45 104.25 112.29"
                        fill="#ddcfe6" data-color="1"></path>
                    <path
                        d="M976.67 352.09v285.45h-8.94L789.2 333.74V599.5c0 11.65 2.83 20.31 8.48 25.97 5.66 5.68 15.99 8.51 30.9 8.51v3.57H752.5v-3.57c12.85 0 21.38-2.83 25.75-8.51 4.31-5.66 6.48-14.32 6.48-25.97V321.23h-28.64v-3.6h95.3l120.81 210.3V352.1c0-11.93-3.81-20.07-11.41-24.39-7.6-4.33-17.99-6.48-31.1-6.48v-3.6h79.22v3.6c-12.54 0-21.08 2.59-25.55 7.81-4.47 5.23-6.68 12.91-6.68 23.06"
                        fill="#ddcfe6" data-color="1"></path>
                    <path
                        d="M144.11 581.3v-62.12c48.55 44.49 113.21 71.58 184.02 71.58s135.55-27.19 184.09-71.68v409.17c0 6.52-.79 12.85-2.17 18.98L144.11 581.29Zm284.07 430.99H144.11V707.07l303.05 303.04c-6.13 1.39-12.46 2.17-18.98 2.17M328.13 133.67c101.44 0 184 82.56 184 184s-82.56 184.11-184 184.11-184.02-82.66-184.02-184.11 82.56-184 184.02-184m272.88 179.45q.1-.1 0-.19C598.54 164.51 477.12 44.69 328.12 44.69S55.13 167.09 55.13 317.67v739.12c0 24.52 19.87 44.49 44.5 44.49h328.56c31.63 0 61.2-8.49 86.71-23.42 26.11-15.03 47.87-36.79 62.88-62.89 14.94-25.5 23.44-55.06 23.44-86.71V317.67c0-1.49-.1-3.06-.2-4.55"
                        fill="#ddcfe6" data-color="1"></path>
                </g>
            </svg>
            <div class="footer-nav-links">
                <a class="footer-nav-link" href="https://www.noeplain.ch">Portfolio</a>
                <a class="footer-nav-link" href="https://www.instagram.com/medie.vom.noe/">Instagram (medie.vom.noe)</a>
                <a class="footer-nav-link" href="https://www.instagram.com/noe.plain.life/">Instagram
                    (noe.plain.life)</a>
                <a class="footer-nav-link" href="https://linkedin.com/in/noe-plain">LinkedIn</a>
            </div>
        </nav>
    </footer>

    <script>
        document.getElementById('hamburgerBtn').addEventListener('click', function () {
            document.getElementById('hamburgerNav').classList.add('open');
            document.getElementById('hamburgerNavBg').classList.add('open');
        });
        document.getElementById('hamburgerNavBg').addEventListener('click', function () {
            document.getElementById('hamburgerNav').classList.remove('open');
            document.getElementById('hamburgerNavBg').classList.remove('open');
        });
    </script>

    <!-- Page-Nav Scroll-Buttons: Positionierung + Verhalten -->
    <script>
        (function () {
            const nav = document.getElementById('page-nav');
            const btn = document.getElementById('page-nav-scroll-btn');
            const leftGrad = document.getElementById('page-nav-left-gradient');
            if (!nav || !btn || !leftGrad) return;

            function updateBtn() {
                const rect = nav.getBoundingClientRect();
                // positioniere Buttons vertikal zentriert zur Nav
                btn.style.top = (rect.top + (rect.height / 2) - (btn.offsetHeight / 2)) + 'px';
                btn.style.left = (rect.right - btn.offsetWidth) + 'px';
                leftGrad.style.top = (rect.top + (rect.height / 2) - (leftGrad.offsetHeight / 2)) + 'px';
                leftGrad.style.left = (rect.left) + 'px';
                btn.style.height = Math.max(40, rect.height) + 'px';
                leftGrad.style.height = Math.max(40, rect.height) + 'px';

                const maxScrollLeft = nav.scrollWidth - nav.clientWidth;
                if (maxScrollLeft > 5 && nav.scrollLeft < maxScrollLeft - 5) btn.classList.remove('hidden');
                else btn.classList.add('hidden');
                if (nav.scrollLeft > 5) leftGrad.classList.remove('hidden');
                else leftGrad.classList.add('hidden');
            }

            function scrollNav(amount) {
                nav.scrollBy({ left: amount, behavior: 'smooth' });
                setTimeout(updateBtn, 420);
            }

            btn.addEventListener('click', () => scrollNav(Math.max(200, nav.clientWidth * 0.6)));
            leftGrad.addEventListener('click', () => scrollNav(-Math.max(200, nav.clientWidth * 0.6)));

            nav.addEventListener('scroll', updateBtn);
            window.addEventListener('resize', updateBtn);
            window.addEventListener('scroll', updateBtn);
            window.addEventListener('orientationchange', updateBtn);
            if (window.ResizeObserver) new ResizeObserver(updateBtn).observe(nav);
            window.requestAnimationFrame(updateBtn);
            window.addEventListener('load', updateBtn);
        })();
    </script>

    <!-- Relaunch Masonry on visibility/focus and ensure relayout after showing a gallery -->
    <script>
        // ensure relayout when returning to the tab / focusing window
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                document.querySelectorAll('.project-gallery').forEach(c => relayoutGrid(c));
            }
        });
        window.addEventListener('focus', () => {
            document.querySelectorAll('.project-gallery').forEach(c => relayoutGrid(c));
        });

        // erweitere showGallery: nach Aktivierung relayout mehrfach (für Fälle, in denen Bilder noch messen)
        const _oldShowGallery = typeof showGallery === 'function' ? showGallery : null;
        if (_oldShowGallery) {
            window.showGallery = function (id, sourceLink = null, push = true) {
                _oldShowGallery(id, sourceLink, push);
                const cat = categories[id];
                if (!cat) return;
                const container = document.getElementById(cat.container);
                if (!container) return;
                // mehrere Versuche spaced out, falls Bilder noch laden / rendering delayed
                setTimeout(() => relayoutGrid(container), 60);
                setTimeout(() => relayoutGrid(container), 300);
                setTimeout(() => relayoutGrid(container), 800);
            };
        }
    </script>


    <section id="detail-screen" class="screen hidden">
        <div class="detail-container">
            <div class="detail-image-wrapper">
                <div class="zoom-container">
                    <div class="zoom-target" id="zoom-target"></div>
                </div>

                <div class="zoom-controls">
                    <i class="fas fa-search-minus small-icon"></i>
                    <input type="range" id="zoom-slider" min="1" max="4" step="0.1" value="1">
                    <i class="fas fa-search-plus small-icon"></i>
                </div>

                <button class="icon-btn detail-nav-button left" id="detail-prev-btn"><i
                        class="fas fa-chevron-left"></i></button>
                <button class="icon-btn detail-nav-button right" id="detail-next-btn"><i
                        class="fas fa-chevron-right"></i></button>
            </div>

            <div class="detail-header-overlay">
                <button class="icon-btn" id="back-btn"><i class="fas fa-chevron-left"></i></button>
                <div class="right-actions">
                    <button class="icon-btn bookmark-btn" id="detail-fav-btn"><i class="far fa-heart"></i></button>
                    <!-- Info Button replaces Add to Album -->
                    <button class="icon-btn" id="info-toggle-btn"><i class="fas fa-info"></i></button>
                    <button class="icon-btn" id="download-btn"><i class="fas fa-download"></i></button>
                </div>
            </div>

            <div class="detail-content" id="detail-content-sheet">
                <button class="sheet-close-btn" id="sheet-close-btn">
                    <i class="fas fa-times"></i>
                </button>

                <!-- Mock Price or remove -->
                <!-- <div class="price-tag" id="detail-price"></div> -->

                <div class="detail-info-header">
                    <h2 id="detail-title"></h2>
                    <p class="photographer"><i class="fas fa-user-circle"></i> <span id="detail-photographer">Noé
                            Plain</span>
                    </p>
                </div>

                <div class="specs-row">
                    <!-- Mock Specs -->
                    <span class="spec-badge"><i class="fas fa-camera"></i> <span id="detail-camera">Sony A7C
                            II</span></span>
                    <span class="spec-badge"><i class="fas fa-bullseye"></i> <span
                            id="detail-aperture">f/1.8</span></span>
                    <!-- <span class="spec-badge"><i class="fas fa-star"></i> <span id="detail-rating">5.0</span></span> -->
                </div>

                <div class="description">
                    <p id="detail-desc"></p>
                </div>
            </div>
        </div>
    </section>



    <div id="modal-add-to-album" class="modal-overlay hidden">
        <div class="modal-card">
            <h3>Zu Album hinzufügen</h3>
            <div id="album-selection-list" class="selection-list"></div>
            <div class="modal-buttons">
                <button class="btn-cancel">Abbrechen</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast hidden"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script>
        // --- STATE MANAGEMENT ---
        let galleryData = []; // Stores objects { id, imageUrl, title, category, ... }
        let activePhotoId = null;
        let favoriteIds = [];
        let albums = [];

        // Zoom Variables
        let currentScale = 1;
        let pannedX = 0;
        let pannedY = 0;

        // --- DOM ELEMENTE ---
        const detailScreen = document.getElementById('detail-screen');
        const zoomTarget = document.getElementById('zoom-target');
        const zoomSlider = document.getElementById('zoom-slider');
        const detailContent = document.getElementById('detail-content-sheet');
        // sheetToggleBtn removed
        const mainHeader = document.querySelector('header'); // Main site header

        // --- COOKIE HELPER ---
        const CookieManager = {
            set: (name, value, days = 365) => {
                const d = new Date();
                d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
                let expires = "expires=" + d.toUTCString();
                document.cookie = name + "=" + JSON.stringify(value) + ";" + expires + ";path=/;SameSite=Strict";
            },
            get: (name) => {
                let nameEQ = name + "=";
                let ca = document.cookie.split(';');
                for (let i = 0; i < ca.length; i++) {
                    let c = ca[i].trim();
                    if (c.indexOf(nameEQ) == 0) {
                        try { return JSON.parse(c.substring(nameEQ.length, c.length)); } catch (e) { return null; }
                    }
                }
                return null;
            }
        };

        // --- INIT ---
        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            // Load Data First
            const savedFavs = CookieManager.get('pl_favs');
            if (savedFavs) favoriteIds = savedFavs;

            const savedAlbums = CookieManager.get('pl_albums');
            if (savedAlbums) albums = savedAlbums;

            // Then Setup UI
            setupPageNav();
            // setupDetailInteractions(); // Removed obsolete function
            setupZoomPan();
            setupEventListeners();
        });

        // --- LOGIC ---

        function setupEventListeners() {
            safeAddClick('back-btn', closeDetail);
            safeAddClick('detail-fav-btn', () => toggleFavorite(activePhotoId));
            safeAddClick('detail-prev-btn', () => navigatePhoto(-1));
            safeAddClick('detail-next-btn', () => navigatePhoto(1));

            // Album Features
            // Info Toggle (replaces Add to Album)
            safeAddClick('info-toggle-btn', () => {
                const sheet = document.getElementById('detail-content-sheet');
                if (sheet) {
                    sheet.classList.toggle('minimized');
                    // We don't toggle icon anymore as requested
                }
            });
            // Close Sheet Button
            safeAddClick('sheet-close-btn', () => {
                const sheet = document.getElementById('detail-content-sheet');
                if (sheet) sheet.classList.add('minimized');
            });

            document.querySelectorAll('.btn-cancel').forEach(btn => {
                btn.addEventListener('click', () => {
                    const modal = btn.closest('.modal-overlay');
                    if (modal) modal.classList.add('hidden');
                });
            });

            safeAddClick('download-btn', () => {
                const photo = galleryData.find(p => p.id === activePhotoId);
                if (photo) {
                    const link = document.createElement('a');
                    link.href = photo.imageUrl;
                    link.download = `NoeMedia_${photo.title || 'photo'}.jpg`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showToast("Download gestartet");
                }
            });

            document.addEventListener('keydown', (e) => {
                if (!detailScreen.classList.contains('active')) return;
                if (e.key === 'ArrowRight') navigatePhoto(1);
                if (e.key === 'ArrowLeft') navigatePhoto(-1);
                if (e.key === 'Escape') closeDetail();
            });
        }

        function safeAddClick(id, func) {
            const el = document.getElementById(id);
            if (el) el.addEventListener('click', func);
        }

        function toggleFavorite(id) {
            if (!id) return;
            if (favoriteIds.includes(id)) {
                favoriteIds = favoriteIds.filter(fid => fid !== id);
                showToast("Entfernt");
            } else {
                favoriteIds.push(id);
                showToast("Favorisiert");
            }
            CookieManager.set('pl_favs', favoriteIds);
            updateDetailFavBtn();
            // Update Tab Visibility in Realtime
            const favTab = document.querySelector('a.tab-btn[href="?favorite"]');
            if (favTab) {
                favTab.style.display = favoriteIds.length > 0 ? 'inline-block' : 'none';
            }
        }

        function updateDetailFavBtn() {
            const btn = document.getElementById('detail-fav-btn');
            if (!btn) return;
            const icon = btn.querySelector('i');
            if (favoriteIds.includes(activePhotoId)) {
                btn.classList.add('active');
                icon.classList.replace('far', 'fas');
            } else {
                btn.classList.remove('active');
                icon.classList.replace('fas', 'far');
            }
        }

        /* --- ALBUM FUNCTIONS --- */
        function showToast(msg) {
            const t = document.getElementById('toast');
            if (!t) return;
            t.innerText = msg;
            t.classList.add('active');
            setTimeout(() => { t.classList.remove('active'); }, 2000);
        }

        // --- DETAIL VIEW ---

        function openDetail(id) {
            activePhotoId = id;
            const photo = galleryData.find(p => p.id === id);
            if (!photo) return;

            currentScale = 1;
            pannedX = 0;
            pannedY = 0;
            if (zoomSlider) zoomSlider.value = 1;
            updateTransform();

            // Check minimized state
            detailContent.classList.add('minimized');

            updateDetailContent(photo);

            if (mainHeader) mainHeader.style.display = 'none'; // Hide header

            if (detailScreen) {
                detailScreen.classList.remove('hidden'); // make display block
                setTimeout(() => detailScreen.classList.add('active'), 10);
            }
        }

        function updateDetailContent(photo) {
            if (zoomTarget) {
                zoomTarget.style.backgroundImage = `url(${photo.imageUrl})`;
            }

            // Title Format: Bild [Nummer] – [Kategorie]
            // We can parse the number from the photo ID or index
            // photo.id e.g. "street-01" -> extract 01
            const numMatch = photo.id.match(/\d+$/);
            const num = numMatch ? numMatch[0] : "00";
            // Capitalize category
            const catDisplay = photo.category.charAt(0).toUpperCase() + photo.category.slice(1);

            document.getElementById('detail-title').innerText = `Bild ${num} – ${catDisplay}`;
            document.getElementById('detail-photographer').innerText = photo.photographer || "Noé Plain";
            document.getElementById('detail-desc').innerText = "Ein Foto aus der Kategorie " + (catDisplay || "Portfolio") + ".";

            // EXIF Data Reading
            const specsRow = document.querySelector('.specs-row');
            if (specsRow) {
                specsRow.innerHTML = ""; // Clear existing

                // Add Loading State
                const loadingSpan = document.createElement('span');
                loadingSpan.className = 'spec-badge loading-badge';
                loadingSpan.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Lade Metadaten...`;
                specsRow.appendChild(loadingSpan);

                exifr.parse(photo.imageUrl).then(exif => {
                    // Clear loading
                    if (specsRow.contains(loadingSpan)) specsRow.removeChild(loadingSpan);

                    // Define helpers
                    function addSpec(icon, text) {
                        const span = document.createElement('span');
                        span.className = 'spec-badge';
                        span.innerHTML = `<i class="${icon}"></i> ${text}`;
                        specsRow.appendChild(span);
                    }

                    if (exif) {
                        // Camera Model
                        if (exif.Model) addSpec('fas fa-camera', exif.Model);
                        // Aperture (F-Stop)
                        if (exif.FNumber) addSpec('fas fa-bullseye', `f/${exif.FNumber}`);
                        // Shutter Speed (ExposureTime)
                        if (exif.ExposureTime) {
                            // Convert decimal to fraction if needed, or simple display
                            const val = exif.ExposureTime;
                            let text = val;
                            if (val < 1) {
                                text = `1/${Math.round(1 / val)}`;
                            } else {
                                text = `${val}s`;
                            }
                            addSpec('fas fa-stopwatch', text);
                        }
                        // ISO
                        if (exif.ISO) addSpec('fas fa-lightbulb', `ISO ${exif.ISO}`);
                    } else {
                        // Fallback if no EXIF found
                        addSpec('fas fa-camera', 'Unbekannte Kamera');
                    }
                }).catch(e => {
                    // Clear loading
                    if (specsRow.contains(loadingSpan)) specsRow.removeChild(loadingSpan);

                    const span = document.createElement('span');
                    span.className = 'spec-badge';
                    span.innerHTML = `<i class="fas fa-info-circle"></i> Keine Metadaten`;
                    specsRow.appendChild(span);
                });
            }

            updateDetailFavBtn();
        }

        function closeDetail() {
            if (detailScreen) {
                detailScreen.classList.remove('active');
                setTimeout(() => {
                    if (mainHeader) mainHeader.style.display = '';
                }, 100);
                setTimeout(() => {
                    detailScreen.classList.add('hidden');
                }, 300);
            }
        }

        function navigatePhoto(direction) {
            // Filter based on currently visible tab content? 
            // For simplicity, navigate all loaded photos of CURRENT CATEGORY if possible.
            // We can check query param to filter galleryData.

            const params = new URLSearchParams(window.location.search);
            let currentCat = 'street';
            if (params.has('tab')) currentCat = params.get('tab');
            else {
                const keys = Object.keys(categories);
                for (let k of keys) {
                    if (params.has(k)) { currentCat = k; break; }
                }
            }

            const currentList = galleryData.filter(p => p.category === currentCat);
            if (currentList.length === 0) return;

            const currentIndex = currentList.findIndex(p => p.id === activePhotoId);
            if (currentIndex === -1) return;

            let newIndex = currentIndex + direction;
            if (newIndex < 0) newIndex = currentList.length - 1;
            if (newIndex >= currentList.length) newIndex = 0;

            activePhotoId = currentList[newIndex].id;

            const wrapper = document.querySelector('.detail-image-wrapper');
            wrapper.style.opacity = 0;
            setTimeout(() => {
                currentScale = 1;
                pannedX = 0; pannedY = 0;
                if (zoomSlider) zoomSlider.value = 1;
                updateTransform();

                updateDetailContent(currentList[newIndex]);
                wrapper.style.opacity = 1;
            }, 200);
        }

        function setupDetailInteractions() {
            // Functionality moved to info-toggle-btn/sheet-close-btn
        }

        function setupZoomPan() {
            if (!zoomSlider || !zoomTarget) return;

            zoomSlider.addEventListener('input', (e) => {
                currentScale = parseFloat(e.target.value);
                updateTransform();
            });

            let isDragging = false;
            let startX = 0;
            let startY = 0;

            const startDrag = (e) => {
                if (currentScale <= 1) return;
                isDragging = true;
                startX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
                startY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
                zoomTarget.style.cursor = 'grabbing';
            };

            const stopDrag = () => {
                isDragging = false;
                zoomTarget.style.cursor = currentScale > 1 ? 'grab' : 'default';
            };

            const moveDrag = (e) => {
                if (!isDragging) return;
                e.preventDefault();

                const currentX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
                const currentY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;

                const diffX = currentX - startX;
                const diffY = currentY - startY;

                pannedX += diffX / currentScale;
                pannedY += diffY / currentScale;

                startX = currentX;
                startY = currentY;

                updateTransform();
            };

            zoomTarget.addEventListener('mousedown', startDrag);
            zoomTarget.addEventListener('touchstart', startDrag, { passive: false });

            window.addEventListener('mouseup', stopDrag);
            window.addEventListener('touchend', stopDrag);

            window.addEventListener('mousemove', moveDrag);
            window.addEventListener('touchmove', moveDrag, { passive: false });
        }

        function updateTransform() {
            if (currentScale == 1) {
                pannedX = 0;
                pannedY = 0;
                if (zoomTarget) zoomTarget.style.cursor = 'default';
            } else {
                if (zoomTarget) zoomTarget.style.cursor = 'grab';
            }

            if (zoomTarget) {
                zoomTarget.style.transform = `scale(${currentScale}) translate(${pannedX}px, ${pannedY}px)`;
            }
        }


        /* --- EXISTING LOGIC MODIFIED --- */

        // Konfiguration der Kategorien
        const categories = {
            street: { prefix: 'street-', container: 'lightgallery-street', path: '../images/portfolio/photography/' },
            aviation: { prefix: 'aviation-', container: 'lightgallery-aviation', path: '../images/portfolio/photography/' },
            portraet: { prefix: 'portraet-', container: 'lightgallery-portraet', path: '../images/portfolio/photography/' },
            bts: { prefix: 'bts-', container: 'lightgallery-bts', path: '../images/portfolio/photography/' },
            event: { prefix: 'event-', container: 'lightgallery-event', path: '../images/portfolio/photography/' },
        };

        /**
         * Berechnet die Anzahl der Spalten basierend auf der Container-Breite.
         */
        function getColumnCount(container, minColWidth = 280) {
            const gap = parseFloat(getComputedStyle(container).gap) || 15;
            const width = container.clientWidth;
            // Mindestens 1 Spalte, maximal 3 (oder mehr, wenn gewünscht)
            const cols = Math.max(1, Math.floor((width + gap) / (minColWidth + gap)));
            return Math.min(3, cols);
        }

        /**
         * NEUE LOGIK:
         * Berechnet die Höhe (row spans) basierend auf der dynamischen Zeilenhöhe (1 Landscape-Höhe).
         */
        function computeSpan(img, itemWidth, rowHeight, gap) {
            // Target Height Portrait (2:3) -> Breite * 1.5
            // Target Height Landscape (3:2) -> Breite / 1.5 ( = rowHeight)

            // Wenn wir strict rowHeight = LandscapeHeight nutzen:
            // Landscape Span = 1
            // Portrait Span = wie viele Landscape-Zeilen passen in ein Portrait?
            // Portrait Height = 1.5 * Width
            // Row Height = 0.666 * Width
            // Span = (TargetH + G) / (RowH + G)

            const naturalRatio = (img.naturalWidth / img.naturalHeight);
            const isPortrait = naturalRatio < 1.0;

            if (!isPortrait) return 1;

            // Für Portrait: Zielhöhe berechnen
            const targetHeight = itemWidth * 1.5;
            // Berechnen des idealen Spans
            const span = Math.round((targetHeight + gap) / (rowHeight + gap));

            // Mindestens 1, meistens wird es 2 sein (da 2*0.66 = 1.33, etwas crop, aber clean grid)
            return Math.max(1, span);
        }

        /**
         * Layoutet das Grid neu. Wird bei Resize, Tab-Wechsel und Bild-Load aufgerufen.
         */
        function relayoutGrid(container) {
            if (!container) return;

            // Spalten berechnen
            const cols = getColumnCount(container, 280);
            container.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

            // Spalten-Breite berechnen (Container minus Gaps geteilt durch Anzahl Spalten)
            // Um präzise CSS Grid Berechnung zu simulieren
            const gap = parseFloat(getComputedStyle(container).gap) || 15;
            const totalGap = (cols - 1) * gap;
            const colWidth = (container.clientWidth - totalGap) / cols;

            // DYNAMISCHE ZEILENHÖHE:
            // Wir setzen die grid-auto-rows exakt auf die Höhe eines Landscape-Bildes (3:2)
            const rowHeight = colWidth / 1.5;
            container.style.gridAutoRows = `${rowHeight}px`;

            // Masonry Algorithmus: Fülle immer die kürzeste Spalte auf
            const colHeights = new Array(cols).fill(0);

            container.querySelectorAll('.gallery-item').forEach(item => {
                const img = item.querySelector('img');
                if (!img) return;

                // Span berechnen mit neuer Logik
                const span = computeSpan(img, colWidth, rowHeight, gap);

                // Finde die Spalte mit der geringsten aktuellen Höhe
                let targetCol = 0;
                for (let i = 1; i < colHeights.length; i++) {
                    if (colHeights[i] < colHeights[targetCol]) {
                        targetCol = i;
                    }
                }

                // Item platzieren
                item.style.gridColumnStart = String(targetCol + 1);
                item.style.gridRowEnd = `span ${span}`;

                // Neue Höhe der Spalte speichern
                colHeights[targetCol] += span * (rowHeight + gap);
            });
        }

        /* --- Loader Logik --- */
        function showLoader(id) {
            if (!window.__activeGalleryLoads) window.__activeGalleryLoads = new Set();
            window.__activeGalleryLoads.add(id || '__global');
            document.getElementById('loader')?.classList.add('visible');
        }

        function hideLoader(id) {
            if (!window.__activeGalleryLoads) window.__activeGalleryLoads = new Set();
            window.__activeGalleryLoads.delete(id || '__global');
            if (window.__activeGalleryLoads.size === 0) {
                document.getElementById('loader')?.classList.remove('visible');
            }
        }

        /**
         * Bilder laden (Sequential Check Pattern)
         */
        function loadImages(categoryId) {
            const cat = categories[categoryId];
            const container = document.getElementById(cat.container);
            if (!container) return;

            // Verhindern, dass wir laden, wenn schon geladen ist oder gerade geladen wird
            if (container.dataset.loaded === "true" || container.dataset.loading === "true") return;

            container.dataset.loading = "true";
            showLoader(cat.container);

            let index = 1;

            function tryLoadNext() {
                // Formatierung: 01, 02, ... 10, 11
                const imgNum = index < 10 ? `0${index}` : index;
                const fileName = `${cat.prefix}${imgNum}.jpeg`;
                const fullPath = cat.path + fileName;

                // Unique ID for internal data
                const photoId = `${cat.prefix}${imgNum}`;

                // Check ob Bild schon im DOM ist (Duplicate check)
                if (container.querySelector(`a.gallery-item[href="${fullPath}"], div.gallery-item[data-id="${photoId}"]`)) {
                    index++;
                    // Safety break bei 999 Bildern
                    if (index > 999) finishLoading();
                    else tryLoadNext();
                    return;
                }

                const img = new Image();
                img.onload = function () {
                    // Modified: Create Div instead of A anchor for custom click handling
                    // Or keep A for accessibility but preventDefault
                    const anchor = document.createElement('a');
                    anchor.className = 'gallery-item';
                    anchor.href = "#";
                    anchor.dataset.id = photoId;

                    // Add to Global Data
                    const photoObj = {
                        id: photoId,
                        imageUrl: fullPath,
                        title: `${categoryId.charAt(0).toUpperCase() + categoryId.slice(1)} #${index}`,
                        category: categoryId,
                        photographer: "Noé Plain",
                    };
                    // avoid duplicates in data
                    if (!galleryData.find(p => p.id === photoId)) {
                        galleryData.push(photoObj);
                    }

                    anchor.addEventListener('click', (e) => {
                        e.preventDefault();
                        openDetail(photoId);
                    });

                    // Alt-Text generieren
                    anchor.innerHTML = `<img src="${fullPath}" alt="${categoryId} photography ${index}">`;

                    container.appendChild(anchor);

                    // Nach jedem Bild kurz layouten, damit es nicht "springt"
                    // requestAnimationFrame sorgt für flüssigen Ablauf
                    requestAnimationFrame(() => relayoutGrid(container));

                    index++;
                    tryLoadNext();
                };

                img.onerror = function () {
                    // Wenn ein Bild nicht gefunden wird (404), gehen wir davon aus, dass die Serie zu Ende ist
                    finishLoading();
                };

                img.src = fullPath;
            }

            function finishLoading() {
                container.dataset.loaded = "true";
                container.dataset.loading = "false";
                hideLoader(cat.container);
                // Finales Layout und Init
                relayoutGrid(container);
            }

            tryLoadNext();
        }

        /**
         * Hauptfunktion zum Anzeigen einer Galerie (Tab-Wechsel)
         */
        function showGallery(id, sourceLink = null, push = true) {
            // UI Updates
            document.querySelectorAll('.gallery-section').forEach(sec => sec.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

            const sec = document.getElementById('section-' + id);
            if (sec) sec.classList.add('active');
            if (sourceLink) sourceLink.classList.add('active');

            // URL Update
            if (push) history.replaceState({}, '', '?' + id);

            if (id === 'favorite') {
                loadFavorites();
            } else {
                // Bilder laden
                loadImages(id);
            }

            const cat = categories[id];
            const containerName = cat ? cat.container : (id === 'favorite' ? 'lightgallery-favorite' : null);

            if (!containerName) return;
            const container = document.getElementById(containerName);

            // Mehrfaches Relayout, um Layout-Shifts durch nachladende Fonts/Styles abzufangen
            if (container) {
                [50, 200, 500].forEach(ms => setTimeout(() => relayoutGrid(container), ms));
            }
        }

        // --- FAVORITES LOGIC ---
        function loadFavorites() {
            const container = document.getElementById('lightgallery-favorite');
            const dlBtn = document.getElementById('download-all-favs');

            if (!container) return;
            container.innerHTML = ""; // Always rebuild to reflect removals

            if (favoriteIds.length === 0) {
                const msg = document.createElement('p');
                msg.innerText = "Noch keine Favoriten markiert.";
                msg.style.color = "#666";
                msg.style.padding = "20px";
                container.appendChild(msg);

                if (dlBtn) dlBtn.style.display = 'none';
                return;
            }

            if (dlBtn) dlBtn.style.display = 'flex';

            favoriteIds.forEach(id => {
                // Parse ID "category-number" e.g. "street-05"
                // Find matching category prefix
                const catKey = Object.keys(categories).find(key => id.startsWith(categories[key].prefix));
                if (!catKey) return;

                const cat = categories[catKey];
                const num = id.replace(cat.prefix, '');
                const fullPath = cat.path + cat.prefix + num + '.jpeg';

                // Construct Element (Div + Image) similar to loadImages
                const anchor = document.createElement('a');
                anchor.className = 'gallery-item';
                anchor.href = "#";
                anchor.dataset.id = id;

                // Add to Global Data if not exists (Favorites might be loaded first)
                const photoObj = {
                    id: id,
                    imageUrl: fullPath,
                    title: `${catKey.charAt(0).toUpperCase() + catKey.slice(1)} #${num}`,
                    category: catKey,
                    photographer: "Noé Plain",
                };
                if (!galleryData.find(p => p.id === id)) {
                    galleryData.push(photoObj);
                }

                anchor.addEventListener('click', (e) => {
                    e.preventDefault();
                    openDetail(id);
                });

                anchor.innerHTML = `<img src="${fullPath}" alt="Favorite ${id}">`;
                container.appendChild(anchor);
            });

            relayoutGrid(container);
        }

        function downloadFavoritesZip() {
            if (favoriteIds.length === 0) {
                showToast("Keine Favoriten zum Downloaden");
                return;
            }
            showToast("ZIP wird erstellt...");

            const zip = new JSZip();
            const folder = zip.folder("NoeMedia_Favorites");
            const promises = [];

            favoriteIds.forEach(id => {
                const photo = galleryData.find(p => p.id === id);
                // Fallback parsing if galleryData is incomplete
                let url = photo ? photo.imageUrl : null;
                if (!url) {
                    const catKey = Object.keys(categories).find(key => id.startsWith(categories[key].prefix));
                    if (catKey) {
                        const cat = categories[catKey];
                        const num = id.replace(cat.prefix, '');
                        url = cat.path + cat.prefix + num + '.jpeg';
                    }
                }

                if (url) {
                    const filename = id + ".jpg";
                    promises.push(
                        fetch(url)
                            .then(res => {
                                if (!res.ok) throw new Error("Fetch fail " + url);
                                return res.blob();
                            })
                            .then(blob => {
                                folder.file(filename, blob);
                            })
                            .catch(err => console.warn("Failed to load for zip:", url))
                    );
                }
            });

            Promise.all(promises).then(() => {
                zip.generateAsync({ type: "blob" }).then(function (content) {
                    // Trigger download
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(content);
                    link.download = "NoePlain_Favorites.zip";
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showToast("Download gestartet");
                });
            });
        }

        /**
         * Setup der Page Navigation (Tabs)
         */
        function setupPageNav() {
            // -- FAVORITES TAB VISIBILITY --
            const favTab = document.querySelector('a.tab-btn[href="?favorite"]');
            if (favTab) {
                if (favoriteIds.length > 0) {
                    favTab.style.display = 'inline-block';
                } else {
                    favTab.style.display = 'none';
                }
            }

            const params = new URLSearchParams(window.location.search);
            let desired = '';

            // Prüfen auf ?tab=street oder einfach ?street
            if (params.has('tab')) desired = params.get('tab') || '';
            else {
                const firstKey = Array.from(params.keys())[0];
                desired = firstKey || (window.location.hash || '').replace('#', '');
            }

            desired = (desired || '').trim().toLowerCase();

            // Fallback auf 'street' wenn nichts oder ungültiges gefunden, 
            // ABER 'favorite' ist auch gültig wenn vorhanden
            const validKeys = [...Object.keys(categories), 'favorite'];
            if (!validKeys.includes(desired)) desired = 'street';

            // Wenn 'favorite' gewünscht ist, aber leer, fallback auf street
            if (desired === 'favorite' && favoriteIds.length === 0) desired = 'street';

            // Event Listener für Buttons
            document.querySelectorAll('#page-nav a.tab-btn').forEach(a => {
                a.addEventListener('click', (e) => {
                    e.preventDefault();
                    const href = (a.getAttribute('href') || '').replace(/^\?/, '').toLowerCase();
                    const id = href || desired;
                    showGallery(id, a, true);
                });
            });

            // Initiale Galerie laden
            const initialLink = document.querySelector(`#page-nav a.tab-btn[href="?${desired}"]`) ||
                document.querySelector('#page-nav a.tab-btn[href="?street"]');

            showGallery(desired, initialLink, false);
        }

        /* --- Event Listeners Global --- */

        // Relayout bei Fenster-Fokus oder Sichtbarkeit (behebt Glitches beim Tab-Wechsel)
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                document.querySelectorAll('.project-gallery').forEach(c => relayoutGrid(c));
            }
        });
        window.addEventListener('focus', () => {
            document.querySelectorAll('.project-gallery').forEach(c => relayoutGrid(c));
        });

        // Resize Handler (Debounced)
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                document.querySelectorAll('.project-gallery').forEach(c => relayoutGrid(c));
            }, 100);
        });

        // We start setupPageNav in DOMContentLoaded (already in Init block)
    </script>
</body>

</html>